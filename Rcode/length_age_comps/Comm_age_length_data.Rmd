---
title: "Exploration commercial length/age comp"
author: "Juliette Champagnat"
date: "2025-02-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# rm(list=ls())
library(tidyverse)
# remotes::install_github("pfmc-assessments/pacfintools")
library(pacfintools)
```


```{r, data loading}
# getwd()
load('../Data/Confidential/PacFIN.YEYE.bds.12.Dec.2024.RData') #biological dataset
load('../Data/Confidential/PacFIN.YEYE.CompFT.12.Dec.2024.RData') #landings
```


# Quick exploration

```{r}
bds.pacfin %>% dim()
bds.pacfin %>% names()
bds.pacfin %>% summary()

catch.pacfin %>% dim()
catch.pacfin %>% names()
catch.pacfin %>% summary()
```


# 0- TO CHECK

# 1- TO SPECIFY

# Bins for biological data

from SAFE 2017 

```{r}
length_bins <- seq(10,74, by = 2) 
age_bins <- seq(0, 65, by = 1) 
```

# The maximum quantile at which to cap all data expansions within getExpansion_1().

```{r}
expansion <- 0.95 ##?to change ?? 
```

I don't think we care because we are not expanding. 

# 2- CHOICES FOR CLEANING DATABASE

## Gear codes

```{r}
bds.pacfin %>% names() %>% grepl(pattern='GEAR') %>% which()
bds.pacfin %>% pull(AGENCY_GEAR_CODE) %>% unique()
bds.pacfin %>% pull(PACFIN_GEAR_CODE) %>% unique()
bds.pacfin %>% pull(PACFIN_GEAR_NAME) %>% unique()

names(catch.pacfin)[catch.pacfin %>% names() %>% grepl(pattern='GEAR') %>% which()]
catch.pacfin %>% pull(GEAR_CODE) %>% unique()
catch.pacfin %>% pull(GEAR_NAME) %>% unique()
catch.pacfin %>% pull(ADJUSTED_GEAR_CODE) %>% unique()
catch.pacfin %>% pull(PACFIN_GEAR_CODE) %>% unique()
catch.pacfin %>% pull(PACFIN_GEAR_DESCRIPTION) %>% unique()
catch.pacfin %>% pull(PACFIN_GROUP_GEAR_CODE) %>% unique()
```


### what group relate to what gear

```{r}

catch.pacfin %>% select(PACFIN_GROUP_GEAR_CODE,PACFIN_GEAR_CODE) %>% distinct() %>% arrange(PACFIN_GROUP_GEAR_CODE)

```

### adding PACFIN_GROUP_GEAR_CODE to bds.pacfin

```{r}
# bds.pacfin <- bds.pacfin %>% 
#   left_join(catch.pacfin %>% select(PACFIN_GEAR_CODE,PACFIN_GROUP_GEAR_CODE) %>% distinct(),by='PACFIN_GEAR_CODE')

bds.pacfin <- bds.pacfin %>% 
  mutate(PACFIN_GROUP_GEAR_CODE = case_when(
  PACFIN_GEAR_CODE %in% c('ODG','SCD') ~ 'DRG',
  PACFIN_GEAR_CODE %in% c('DRL','HDL','HLR','JIG','LGL','OHL','POL','STL','VHL') ~ 'HKL',
  PACFIN_GEAR_CODE %in% c('DVG','OTH','RVT','USP') ~ 'MSP',
  PACFIN_GEAR_CODE %in% c('DGN','DPN','GLN','ONT','SEN','SGN','STN','TML') ~ 'NET',
  PACFIN_GEAR_CODE %in% c('CLP','CPT','FPT','LPT','OPT','PRW','SPT') ~ 'POT',
  PACFIN_GEAR_CODE %in% c('BTR','HTR','PTR','TRL') ~ 'TLS',
  PACFIN_GEAR_CODE %in%c('BMT','BTT','CBF','CBJ','DNT','FFT','FTS',  
     'GFL','GFS','GFT','LFZ','MDT','MPT','OTW','PRT','RLT','SFZ','SRM') ~ 'TWL',
  PACFIN_GEAR_CODE %in% c('DST','PWT','SHT','SST') ~ 'TWS',
  TRUE ~ NA))

```


### display nb of records by GROUP_GEAR

```{r}
bds.pacfin %>% 
  group_by(PACFIN_GROUP_GEAR_CODE) %>% 
  summarise(n=length(PACFIN_GROUP_GEAR_CODE))
```

there is NAs, what are these?

```{r}
bds.pacfin %>% 
  filter(is.na(PACFIN_GROUP_GEAR_CODE)) %>% 
  group_by(PACFIN_GROUP_GEAR_CODE,PACFIN_GEAR_CODE,PACFIN_GEAR_NAME) %>% 
  summarise(n=length(PACFIN_GEAR_NAME))

```

* checking here what are they https://reports.psmfc.org/pacfin/f?p=501:804:2720028309398:INITIAL:::: 
** HKL: ALL HOOK AND LINE GEAR EXCEPT TROLL -> group HKL
** TWL: ALL TRAWLS EXCEPT SHRIMP TRAWLS -> group TWL
-> should they been added to HKL and TWL?


### display nb of records by GEAR

```{r}
bds.pacfin %>% 
  group_by(PACFIN_GEAR_CODE,PACFIN_GEAR_NAME) %>% 
  summarise(n=length(PACFIN_GEAR_CODE)) %>%  arrange(desc(n))

# bds.pacfin %>% filter(PACFIN_GEAR_CODE %in% c('DST','PWT','SHT','SST'))
```

### CHOICE : Gear to keep

```{r}
used_gears <- c("HKL", "TWL")
```

is it a gear code and a gear group?

## Length type

```{r}
bds.pacfin %>%
  group_by(AGENCY_CODE,FISH_LENGTH_TYPE_CODE) %>% 
  summarise(n=length(FISH_LENGTH_TYPE_CODE))
```

What should we do with NAs and Unknow?

### CHOICE: length type

```{r}
# Keep all alternate (A), fork (F), and unknown (U) length types based on FISH_LENGTH_TYPE_CODE
good_lengths <- c("F") #"U" ?

```

## Sample method

```{r}
bds.pacfin %>%
  group_by(AGENCY_CODE,SAMPLE_METHOD_CODE) %>% 
  summarise(n=length(SAMPLE_METHOD_CODE))
```


### CHOICE: sample methods



```{r}
# Keep only random (R) samples based on SAMPLE_METHOD_CODE. Only random samples
# should be retained unless specified by a state agency.
good_methods <- "R"
```

## Sample type

```{r}
bds.pacfin %>%
  group_by(AGENCY_CODE,SAMPLE_TYPE) %>% 
  summarise(n=length(SAMPLE_TYPE))
```

what is 'S' ? Should it be kept?


### CHOICE: sample type

```{r}
# Keep commercial on-board (C), market (M), and blank samples based on SAMPLE_TYPE
good_samples <- c("", "M", "C")
```

## State

```{r}
bds.pacfin %>%
  group_by(AGENCY_CODE) %>% 
  summarise(n=length(AGENCY_CODE))
```

### CHOICE: states

```{r}
# Keep data from all 3 states. This is the default.
good_states <- c("WA", "OR", "CA")
```



## Ageing method

```{r}
bds.pacfin %>%
  filter(!is.na(age1)) %>%
  group_by(AGENCY_CODE,AGE_METHOD1) %>% 
  summarise(n=length(AGE_METHOD1))
```


### CHOICE: ageing method

```{r}
# Keep only break and burn (B, BB), unknown (U), and blank (") age reads based
# on AGE_METHOD. This decision should be species-specific.
good_age_method <- c("B", "1")
```


# 3- CLEANING DATABASE

```{r}

bds_cleaned <- cleanPacFIN(
  Pdata = bds.pacfin,
  keep_gears = used_gears,
  CLEAN = TRUE,
  keep_age_method = good_age_method,
  keep_sample_type = good_samples,
  keep_sample_method = good_methods,
  keep_length_type = good_lengths,
  keep_states = good_states,
  spp = "yelloweye") |>
  dplyr::mutate(
    stratification = paste(state, geargroup, sep = "."),
    # making another stratification corresponding to model area
    stratification_byarea = ifelse(state=="CA",paste(state, geargroup, sep = "."), 
                                   paste("ORWA", geargroup, sep = ".")),
    # the model is not sexed so it is easier to put everything as unsexed for later calculations
    SEX='U') 

## make the same but keeping al the records so I can see what was removed
bds_cleaned_full <- cleanPacFIN(
  Pdata = bds.pacfin,
  keep_gears = used_gears,
  CLEAN = FALSE,
  keep_age_method = good_age_method,
  keep_sample_type = good_samples,
  keep_sample_method = good_methods,
  keep_length_type = good_lengths,
  keep_states = good_states,
  spp = "yelloweye") |>
  dplyr::mutate(
    stratification = paste(state, geargroup, sep = "."),
    # making another stratification corresponding to model area
    stratification_byarea = ifelse(state=="CA",paste(state, geargroup, sep = "."), 
                                   paste("ORWA", geargroup, sep = ".")),
    # the model is not sexed so it is easier to put everything as unsexed for later calculations
    SEX='U') 


```



```{r}
nrow(bds.pacfin);nrow(bds_cleaned)
ncol(bds.pacfin);ncol(bds_cleaned)
names(bds_cleaned)
```


# 4- CLEAN DATABASE EXPLORATION

## gear

```{r}
bds_cleaned %>% 
  group_by(geargroup) %>% 
  summarise(n=length(geargroup))

bds_cleaned %>% 
  # filter(is.na(PACFIN_GROUP_GEAR_CODE)) %>%
  group_by(geargroup,PACFIN_GEAR_NAME) %>% 
    summarise(n=length(PACFIN_GEAR_NAME))

#plot gear along time
bds_cleaned %>%
    filter(geargroup=='TWL') %>% 
    group_by(year,stratification_byarea,geargroup,PACFIN_GEAR_NAME) %>% 
    summarise(n=length(SAMPLE_NO)) %>% 
    ggplot()+geom_bar(aes(year,n,fill=PACFIN_GEAR_NAME),position='stack',stat='identity')+facet_wrap(~stratification_byarea,nrow=2)

bds_cleaned %>%
    filter(!geargroup=='TWL') %>% 
    group_by(year,stratification_byarea,geargroup,PACFIN_GEAR_NAME) %>% 
    summarise(n=length(SAMPLE_NO)) %>% 
    ggplot()+geom_bar(aes(year,n,fill=PACFIN_GEAR_NAME),position='stack',stat='identity')+facet_wrap(~stratification_byarea,nrow=2)


bds_cleaned %>%
    group_by(year,stratification_byarea,PACFIN_GEAR_NAME) %>% 
    filter(PACFIN_GEAR_NAME%in%c('TRAWLS')) %>% 
    summarise(n=length(SAMPLE_NO))


```

## Nb of length/ages by strate (region x fleet)

```{r}
# bds_cleaned %>% 
#   group_by(stratification) %>% 
#     summarise(n=length(stratification))
 
bds_cleaned %>%
  group_by(stratification) %>%
    summarise(n_length=sum(!is.na(length)),n_age=sum(!is.na(Age)))

# bds_cleaned %>% 
#   filter(!is.na(FISH_LENGTH)) %>% 
#   group_by(stratification) %>% 
#     summarise(n=length(stratification))

# bds_cleaned %>% 
#   filter(!is.na(Age)) %>% 
#   group_by(stratification) %>% 
#     summarise(n=length(stratification))

#plot n_fish
bds_cleaned %>%
  group_by(stratification,year) %>%
    summarise(n_length=sum(!is.na(length)),n_age=sum(!is.na(Age))) %>% 
  ggplot(aes(year, stratification))+geom_text(aes(label=n_length))


```

## Trip

```{r}

bds_cleaned %>% pull(FTID) %>% unique() %>% length()

bds_cleaned %>% pull(FTID) %>% is.na() %>% sum()

bds_cleaned %>% pull(SAMPLE_NO) %>% unique() %>% length()
nrow(bds_cleaned)

bds_cleaned %>% 
  group_by(stratification_byarea) %>% 
  summarize(FTID_NA=sum(is.na(FTID)),FTID_nNA=sum(!is.na(FTID)),
            FTID_tot=length(FTID)) %>% 
  mutate(verif=FTID_NA+FTID_nNA)


bds_cleaned %>%
  group_by(year,stratification_byarea) %>%
  filter(!is.na(FTID)) %>% 
  filter(!is.na(length)) %>% 
  summarise(n_trips=length(unique(FTID)),n_fish=length(length)) 


# df n_fish + n_trip long format
bds_cleaned %>%
  group_by(stratification_byarea,year) %>%
  filter(!is.na(length)) %>% 
  summarise(n_fish=length(length),
            n_trips=length(unique(SAMPLE_NO)),
            n_trips2=length(unique(FTID)),
            n_trips3=length((FTID))) %>% 
  mutate(diff=n_trips-n_trips2)


# check 2 ways of counting trips -> they match
bds_cleaned %>% 
  group_by(stratification_byarea,year) %>%
  filter(!is.na(FTID)) %>%
  filter(!is.na(length)) %>% 
  # first way of computing trips
  distinct(FTID) %>% 
  summarize(n_trips=length(FTID)) %>%
  ## merge with a second one to compare
  full_join(bds_cleaned %>% 
  group_by(stratification_byarea,year) %>%
  filter(!is.na(FTID)) %>%
  filter(!is.na(length)) %>% 
  summarize(n_trips2=length(unique(FTID))),
  by=c('stratification_byarea','year')) %>% 
  mutate(isequal=n_trips==n_trips2) %>% summary()
  # filter(!isequal)
```

certain nb of NA in FTID -> filter them out?


# 5- COMPUTE SAMPLING EFFORT

Need a number of trips and fish samples per year per stratification

a row = a fish
SAMPLE_NO = sample number (sometime a tow sometime not)
FTID = a fish ticket = proxy of a trip

```{r}
file_path = "../../Data/processed/length_age_comps/"
```


## 5.1- Length sampling effort


### Number of trip and sample

#### Computation

```{r}

# df n_fish + n_trip 
length_sample_effort <- bds_cleaned %>%
  group_by(year,stratification_byarea) %>%
  filter(!is.na(FTID)) %>% 
  filter(!is.na(length)) %>% 
  summarise(n_trips=length(unique(FTID)),n_fish=length(length)) 


# df n_fish + n_trip large format
length_sample_effort_wide <- length_sample_effort %>% 
  pivot_wider(id_cols = year,names_from = c(stratification_byarea),
              values_from = c(n_trips,n_fish),
              names_glue="{stratification_byarea}_{.value}") %>% 
  relocate(year,CA.TWL_n_trips,CA.TWL_n_fish,
           CA.HKL_n_trips,CA.HKL_n_fish,
           ORWA.TWL_n_trips,ORWA.TWL_n_fish,
           ORWA.HKL_n_trips,ORWA.HKL_n_fish) #%>% 

  write.csv(length_sample_effort_wide,row.names = FALSE,
            file =paste0(file_path,"Commercial_length_sampling_effort.csv"))


```

```{r}
#plot these numbers
minmaxy_l <- c(min(length_sample_effort$year),max(length_sample_effort$year))

length_sample_effort_plt <- length_sample_effort_wide %>% 
  pivot_longer(cols=-year) %>% 
  ggplot(aes(x="",y=-year))+geom_tile(aes(fill=value))+
  geom_text(aes(label=value))+facet_wrap(~name,nrow=1)+
  scale_fill_gradient2()+
  scale_y_continuous(breaks=-seq(minmaxy_l[1],minmaxy_l[2],1))+
  labs(x='stratification_byarea*(numbers of trips OR fish)',y='year',
       title="Updated length sampling effort")+
  theme(legend.position='bottom') 

length_sample_effort_plt
# ggsave(length_sample_effort_plt,filename=
#          paste0(file_path,"Commercial_length_sampling_effort.png"),
#        width=12,height = 8)
```

#### Compare w 2017 SAFE

```{r}

# compare with 2017 SAFE
length_sample_effort_2017 <- read.csv(file=paste0(file_path,"2017SAFE_Table21-22_commercial_length_sampling_effort.csv"))%>% 
  pivot_longer(cols = -year,values_to = 'prev_value') %>% 
  separate(name,sep="_",
           into=c("stratification_byarea","B",'C')) %>% 
  mutate(var=paste0(B,'_',C),
         # pre_value=case_when(is.na(prev_value)~0,.default=pre_value)
         ) %>% 
  select(year,stratification_byarea,var,prev_value)
  
comp_length_sample_effort <- length_sample_effort %>%
  #convert to long format
  pivot_longer(cols=c(n_trips,n_fish),
               values_to = 'new_value',names_to = 'var') %>% 
  filter(year<2017) %>% #filter most recent year
  full_join(length_sample_effort_2017,
            by=c('stratification_byarea','year','var')) %>% 
  arrange(year) %>% 
  mutate(prev_value=replace_na(prev_value,0),
            new_value=replace_na(new_value,0)) %>% 
  mutate(diff=new_value-prev_value) %>% #summary()
  pivot_wider(id_cols = year,
              names_from = c(stratification_byarea,var),
              values_from = c(diff)) #%>% #View() 
  
  
write.csv(comp_length_sample_effort,row.names = FALSE,
            file =paste0(file_path,"Commercial_length_sampling_effort_DIFF.csv"))
  
```



```{r}
minmaxy_lcomp <- c(min(comp_length_sample_effort$year),max(comp_length_sample_effort$year))

# plot diff with scaled color
comp_length_sample_effort_plt <- comp_length_sample_effort %>%
  pivot_longer(cols=-year,values_to = 'diff') %>%
  ggplot(aes(x="",y=-year))+geom_tile(aes(fill=diff))+
  geom_text(aes(label=diff))+facet_wrap(~name,nrow=1)+
  scale_fill_gradient2()+
  scale_y_continuous(breaks=-seq(minmaxy_lcomp[1],minmaxy_lcomp[2],1))+
  labs(x='stratification_byarea*(numbers of trips OR fish)',y='year',
       title="Length sampling effort comparison with 2017 (diff=new value - previous value)")+
  theme(legend.position='bottom') 

comp_length_sample_effort_plt
  
ggsave(comp_length_sample_effort_plt,path=file_path,
       filename="Commercial_length_sampling_effort_DIFF.png",
       height=7,width=12)
```

### Sample size

Formula from 2017 SAFE p41

```{r}
sample_size_length <- bds_cleaned %>%
  group_by(year,stratification_byarea) %>%
  filter(!is.na(length)) %>% 
  summarise(N_fish=length(length),N_trips=length(unique(FTID))) %>% 
  mutate(N_input = ifelse(N_fish/N_trips<44,N_trips+0.138*N_fish,7.06*N_trips))
sample_size_length
```


## 5.2- Age sampling effort

### trips and samples 

#### Computation

```{r}

# df n_fish + n_trip large format
age_sample_effort <- bds_cleaned %>%
  group_by(year,stratification_byarea) %>%
  filter(!is.na(FTID)) %>% #remove NA fish tickets
  filter(!is.na(Age)) %>%  #remove rows with no age samples
  summarise(n_trips=length(unique(FTID)),n_fish=length(Age)) #compute 

# df n_fish + n_trip large format
age_sample_effort_wide <- age_sample_effort %>% 
  pivot_wider(id_cols = year,
              names_from = c(stratification_byarea),
              values_from = c(n_trips,n_fish),
              names_glue="{stratification_byarea}_{.value}") %>% 
  relocate(year,#CA.TWL_n_trips,CA.TWL_n_fish,
                #CA.HKL_n_trips,CA.HKL_n_fish,
                ORWA.TWL_n_trips,ORWA.TWL_n_fish,
                ORWA.HKL_n_trips,ORWA.HKL_n_fish) #%>% View()
  
  
# write.csv(age_sample_effort_wide,row.names = FALSE,
#             file = paste0(file_path,"Commercial_age_sampling_effort.csv"))

```


```{r}
minmaxy_age <- c(min(age_sample_effort$year),max(age_sample_effort$year))

#plot these numbers
age_sample_effort_plt <- age_sample_effort %>% 
  pivot_longer(cols=c(n_trips,n_fish),
               values_to = 'value',names_to = 'var') %>% 
  mutate(name=paste0(stratification_byarea,'_',var)) %>% 
  ggplot(aes(x="",y=-year))+geom_tile(aes(fill=value))+
  geom_text(aes(label=value))+facet_wrap(~name,nrow=1)+
  scale_fill_gradient2()+
  scale_y_continuous(breaks=-seq(minmaxy_age[1],minmaxy_age[2],1))+
  labs(x='stratification_byarea*(numbers of trips OR fish)',y='year',
       title="Updated age sampling effort")+
  theme(legend.position='bottom') 

age_sample_effort_plt

# ggsave(age_sample_effort_plt,filename=
#          paste0(file_path,"Commercial_age_sampling_effort.png"),
#        width=8,height = 5)
```

#### Compare with 2017 SAFE

```{r}

#loading table
age_sample_effort_2017 <- read.csv(file=paste0(file_path,"/2017SAFE_Table23-24_commercial_age_sampling_effort.csv")) %>% 
  pivot_longer(cols = -year,values_to = 'prev_value') %>% 
  separate(name,sep="_",
           into=c("stratification_byarea","B",'C')) %>% 
  mutate(var=paste0(B,'_',C),
         # prev_value=case_when(is.na(pre_value)~0,.default=pre_value)
         ) %>% 
  select(year,stratification_byarea,var,prev_value)

## make a df with differences  
comp_age_sample_effort <- age_sample_effort %>% 
  #convert to long format
  pivot_longer(cols=c(n_trips,n_fish),
               values_to = 'new_value',names_to = 'var') %>% 
  filter(year<2017) %>% #comparison on past years only
  # merge with 2017 data
  full_join(age_sample_effort_2017,
            by=c('stratification_byarea','year','var')) %>% 
  arrange(year) %>% 
  mutate(prev_value=replace_na(prev_value,0),
            new_value=replace_na(new_value,0)) %>% 
  mutate(diff=new_value-prev_value) %>% #summary()
  pivot_wider(id_cols = year,
              names_from = c(stratification_byarea,var),
              values_from = c(diff)) #%>% #View()
  
 comp_age_sample_effort 
 # write.csv(comp_age_sample_effort,row.names = FALSE,file =
 #  paste0(file_path,"Commercial_age_sampling_effort_DIFF.csv")


## compute summary of differences -> no info if it's + or -
colSums(abs(comp_age_sample_effort))

```



```{r}
minmaxy_agecomp <- c(min(comp_age_sample_effort$year),max(comp_age_sample_effort$year))

# plot diff with scaled color
comp_age_sample_effort_plt <- comp_age_sample_effort %>% 
  pivot_longer(cols=-year,values_to = 'diff') %>% 
  ggplot(aes(x="",y=-year))+geom_tile(aes(fill=diff))+
  geom_text(aes(label=diff))+facet_wrap(~name,nrow=1)+
  scale_fill_gradient2()+
  scale_y_continuous(breaks=-seq(minmaxy_agecomp[1],minmaxy_agecomp[2],1))+
  labs(x='stratification_byarea*(numbers of trips OR fish)',y='year',
       title="Age sampling effort comparison with 2017 (diff=new value - previous value)")+
  theme(legend.position='bottom') 

comp_age_sample_effort_plt
  
# ggsave(comp_age_sample_effort_plt,path=file_path,
#        filename="Commercial_age_sampling_effort_DIFF.png",
#        height=6,width=12)
```

<!-- #### investigate missing age samples from CA.non-trawl -->

<!-- ```{r} -->

<!-- bds_cleaned_full %>%  -->
<!--   filter(!is.na(Age),CLEAN==FALSE,state=='CA')  -->

<!-- ``` -->

<!-- This database does not contain any ages from CA. -->

<!-- #### investigate augmented age samples from OR-WA.TWL -->


<!-- ```{r} -->
<!-- # df n_fish + n_trip large format -->
<!-- bds_cleaned %>% -->
<!--   group_by(year,stratification) %>% -->
<!--   filter(!is.na(Age),state!='CA',geargroup=='TWL') %>%  -->
<!--   summarise(n_trips=length(unique(SAMPLE_NO)),n_fish=length(Age)) %>%  -->
<!--   pivot_wider(id_cols = year,names_from = c(stratification),values_from = c(n_trips,n_fish),names_glue="{stratification}_{.value}") %>%  -->
<!--   filter(year %in% c(2004:2006,2015:2016)) %>%  #filter years where I have discrepencies -->
<!--   relocate(year,OR.TWL_n_trips,OR.TWL_n_fish,WA.TWL_n_trips,WA.TWL_n_fish) -->

<!-- ``` -->


<!-- #### investigate augmented age samples from OR-WA.HKL -->

<!-- ```{r} -->
<!-- # df n_fish + n_trip large format -->
<!-- bds_cleaned %>% -->
<!--   group_by(year,stratification) %>% -->
<!--   filter(!is.na(Age),state!='CA',geargroup=='HKL') %>%  -->
<!--   summarise(n_trips=length(unique(SAMPLE_NO)),n_fish=length(Age)) %>%  -->
<!--   pivot_wider(id_cols = year,names_from = c(stratification),values_from = c(n_trips,n_fish),names_glue="{stratification}_{.value}") %>%  -->
<!--   filter(year %in% c(2001,2003:2007,2014)) %>%  #filter years where I have discrepencies -->
<!--   relocate(year,OR.HKL_n_trips,OR.HKL_n_fish, -->
<!--           WA.HKL_n_trips,WA.HKL_n_fish)  -->


<!-- ``` -->


<!-- #### first age samples -->

<!-- ```{r} -->
<!-- bds_cleaned %>% -->
<!--   group_by(year,stratification) %>% -->
<!--   filter(!is.na(Age)) %>%  -->
<!--   summarise(n_trips=length(unique(SAMPLE_NO)),n_fish=length(Age)) %>%  -->
<!--   pivot_wider(id_cols = year,names_from = c(stratification),values_from = c(n_trips,n_fish),names_glue="{stratification}_{.value}") %>%  -->
<!--   filter(year %in% c(2001,2003:2007,2014)) %>%  #filter years where I have discrepencies -->
<!--   relocate(year,OR.HKL_n_trips,OR.HKL_n_fish, -->
<!--           WA.HKL_n_trips,WA.HKL_n_fish)  -->

<!-- ``` -->



### sample size

 Formula from 2017 SAFE p41

```{r}
sample_size_age <- bds_cleaned %>%
  group_by(year,stratification_byarea) %>%
  filter(!is.na(Age)) %>% 
  summarise(N_fish=length(Age),N_trips=length(unique(FTID))) %>% 
  mutate(N_input = ifelse(N_fish/N_trips<44,N_trips+0.138*N_fish,7.06*N_trips))
sample_size_age
```


## Plots

### PacFin plots - general

```{r}

plotCleaned(bds_cleaned,savedir = getwd())

```

### PacFIN plot - length/age

```{r}
plotStrat(data=bds_cleaned,dir = getwd())
?plotStrat()
```

function is not working

### length distribution

```{r}

bds_cleaned %>%
  group_by(stratification_byarea,year) %>%
  filter(!is.na(length)) %>% 
  ggplot(aes(year,length))

```


# 6- EXPANSION

No expansion is done for this species because of too low samples numbers

p41 of 2017 SAFE

"Due to very sparse sampling (mainly opportunistic, since yelloweye have been landed in very small proportions of mixed species market categories or recreational bag limits) length frequencies are raw, calculated as the count of fish among size bins. This has been the case in previous assessments, and preliminary investigation of alternate weighting procedures revealed little sensitivity to this choice."


# 7- COMPUTING COMPS

Instructors advise to use getrawComp from nwfscSurvey
-> can also use PacFINtools::getComps() to double check?


## 7.1- LENGTH COMPS


```{r}

# length_comps_long <- getComps(
#   Pdata = bds_cleaned %>% filter(!is.na(lengthcm)) %>% 
#     left_join(sample_size_length,
#   by=c('year','stratification_byarea')),
#   defaults = c("fishyr", "season",'stratification_byarea'),
#   Comps = "LEN",
#   weightid = "N_input"
# )
# 
# 
# length_comps_long %>% 
#   ggplot(aes(fishyr,lengthcm))+geom_point(aes(size=comp))+facet_wrap(~stratification_byarea,ncol=1)+
#   theme_bw()+labs(x='Year',y='Length')

# length_comps_long %>% 
#   ggplot(aes(fishyr,lengthcm))+geom_point(aes(size=n_fish))+facet_wrap(~stratification_byarea)
```

## 7.2- AGE COMPS

```{r}

# age_comps_long <- getComps(
#   Pdata = bds_cleaned %>% filter(!is.na(Age)) %>% 
#     left_join( sample_size_age,
#   by=c('year','stratification_byarea')),
#   defaults = c("fishyr", "season",'stratification_byarea'),
#   Comps = "AGE",
#   weightid = "N_input"
# )
# 
# 
# age_comps_long %>% 
#   ggplot(aes(fishyr,Age))+geom_point(aes(size=comp))+facet_wrap(~stratification_byarea,ncol=1)+
#   theme_bw()+labs(x='Year',y='Age')


```

