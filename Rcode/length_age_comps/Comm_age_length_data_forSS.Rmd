---
title: "Comm_age_length_data_forSS"
author: "Juliette Champagnat"
date: "2025-04-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# rm(list=ls())
library(tidyverse)
# remotes::install_github("pfmc-assessments/pacfintools")
# library(pacfintools)
# remotes::install_github("pfmc-assessments/nwfscSurvey")
# library(nwfscSurvey)
library(r4ss)

```

## Load data

```{r}
#path for data
file_path = "../../Data/processed/length_age_comps/"

ss_data <- SS_readdat(file="../../model/2017_yelloweye_model_updated_ss3_exe/yelloweye_data.ss")
# wcgop_age_comps

# length comps, maal and caal from PacFIN AND WCGOP
raw_length_comps_comb <- read.csv(paste0(file_path,' Commercial_length_comps_PacFIN_WCGOP_forSS.csv'))
raw_age_caal_comb <- read.csv(paste0(file_path,'Commercial_caal_PacFIN_WCGOP_forSS.csv'))
raw_age_comps_comb <- read.csv(paste0(file_path,' Commercial_age_comps_PacFIN_WCGOP_forSS.csv'))

```

## format to good names

```{r}
# length comps
dim(raw_length_comps_comb);dim(ss_data$lencomp)
names(raw_length_comps_comb); names(ss_data$lencomp)
names(raw_length_comps_comb) <- names(ss_data$lencomp)

# caal
dim(raw_age_caal_comb);dim(ss_data$agecomp)
names(raw_age_caal_comb); names(ss_data$agecomp)
names(raw_age_caal_comb) <- names(ss_data$agecomp)

# maal 
dim(raw_age_comps_comb);dim(ss_data$agecomp)
names(raw_age_comps_comb); names(ss_data$agecomp)
names(raw_age_comps_comb) <- names(ss_data$agecomp)
```


## reminder of fleet name

CA.TWL             1
CA.NONTWL          2
ORWA.TWL           4
ORWA.NONTWL        5

# LENGHT

## CA_TWL, PacFIN 

2017 file = 1978-2015
updated data = 2016-2024

READY = no check if we want to mix PacFIN and WCGOP, it's the case for now

```{r}
CA_TWL_PacFIN_length <- ss_data$lencomp %>% filter(fleet==1,year<=2015) %>% 
  bind_rows(raw_length_comps_comb %>% 
  filter(fleet==1,year>2015))
```


## CA_NONTWL, PacFIN

2017 file = 1979 - 2002
update data = 

READY = no check if we want to mix PacFIN and WCGOP, it's the case for now

```{r}
# CA_NONTWL_PacFIN_length <- ss_data$lencomp %>% filter(fleet==2,year<2015) %>% 
#   bind_rows(raw_length_comps_comb %>% 
#   filter(fleet==1,year>2015))

```

## CA_NONTWL, WCGOP

2004-2015

## ORWA_TWL, PacFIN and WCGOP combined

2017 file = 1995-2015
updated data = 2016-2024

```{r}
# check for overlapping year
ss_data$lencomp %>% filter(fleet==4,year==2015) == raw_length_comps_comb %>%filter(fleet==4,year==2015) 
#2015 is identical-> use data from 2017 datafile
ss_data$lencomp %>% filter(fleet==4,year==2016) == raw_length_comps_comb %>%filter(fleet==4,year==2016) 
# 2016 is different -> use updated data
```

READY for SS = Yes

```{r}
ORWA_TWL_PacFIN_WCGOP_length <- ss_data$lencomp %>% filter(fleet==4,year<=2015) %>% 
  bind_rows(raw_length_comps_comb %>% 
  filter(fleet==4,year>2015))
```

## ORWA_NONTWL, PacFIN and WCGOP combined

2017 file = 1980-2015
updated data = 2016-2024

```{r}
# check for overlapping year
ss_data$lencomp %>% filter(fleet==5,year==2015) == raw_length_comps_comb %>%filter(fleet==5,year==2015) 
#2015 is identical-> use data from 2017 datafile

```

ready for SS = YES

```{r}
ORWA_NONTWL_PacFIN_WCGOP_length <- ss_data$lencomp %>% filter(fleet==5,year<=2015) %>% 
  bind_rows(raw_length_comps_comb %>% filter(fleet==5,year>2015))
```
## Combine everything

TBD when all previous issues are resolved

```{r}

```



# AGE 

## CA_NONTWL

### CA_NONTWL, CAAL, data from CDFW, Traci file

2017 file = 1978-1988
no updated data

```{r}
# check for updated data
raw_age_caal_comb %>% filter(fleet==2,year>1988) #these are WCGOP data

```

pb of doubling 

```{r}
raw_age_caal_comb %>% filter(fleet==2,year<=1988) %>% nrow()
ss_data$agecomp %>% filter(fleet==2,year<=1988) %>% nrow()

# #another length bin in
# raw_age_caal_comb %>% filter(fleet==2,year==1979) == ss_data$agecomp %>% filter(fleet==2,year==1979) #bin does not match
# 
# raw_age_caal_comb %>% filter(fleet==2,year==1979,Lbin_lo==50)
# ss_data$agecomp %>% filter(fleet==2,year==1979,Lbin_lo==50)
# 
# raw_age_caal_comb %>% filter(fleet==2,year!=1979) == ss_data$agecomp %>% filter(fleet==2,year!=1979) %>% mutate_at(vars(-c('year','month','fleet','sex','part','ageerr','Lbin_lo','Lbin_hi')), .funs=function(x){x/2})

#check for which year /2 caal poses pb -> 1979/2005
ss_data$agecomp %>% filter(fleet==2,year<2016) %>% 
  pivot_longer(cols=-c(year,month,fleet,sex,part,
                                     ageerr,Lbin_lo,Lbin_hi,Nsamp),
                             names_prefix='a',names_to = 'age',
                             values_transform = as.numeric, values_to = "prev_value") %>% 
  mutate(bb=prev_value/2) %>% filter(!bb%in%c(0:100)) %>% View()

```

ready = NO

```{r}
CA_NONTWL_TraciCDFW_caal <- ss_data$agecomp %>% filter(fleet==2,year<=1988) #%>% 
  mutate_at(vars(-c('year','month','fleet','sex','part','ageerr','Lbin_lo','Lbin_hi')), .funs=function(x){x/2}) 
  
CA_NONTWL_TraciCDFW_caal %>% View()

```


### CA_NONTWL, MAAL ghost, not expanded, data from CDFW, Traci file

2017 file = 1978-1988
no updated data

```{r}
# check for updated data
raw_age_comps_comb %>% filter(fleet==-2,year>1988) #these are WCGOP data
```

ready = YES
 
```{r}
CA_NONTWL_TraciCDFW_maal <- ss_data$agecomp %>% filter(fleet==-2,year<=1988) 
``` 

### CA_NONTWL, CAAL, WCGOP

2017 file = 2005
no updated data 

```{r}
# check for updated data
raw_age_caal_comb %>% filter(fleet==2,year>=2005) 
```

no doubling issue

```{r}
 ss_data$agecomp %>% filter(fleet==2,year==2005) 
```

ready = YES

```{r}
CA_NONTWL_WCGOP_caal <- ss_data$agecomp %>% filter(fleet==2,year==2005) 
```

### CA_NONTWL, WCGOP, ghost MAAL

2017 file = 2015
no updated data

```{r}
# check for updated data
raw_age_comps_comb %>% filter(fleet==-2,year>2005) #no new data
```

ready = yes 

```{r}
CA_NONTWL_WCGOP_maal <- ss_data$agecomp %>% filter(fleet==-2,year==2005) 
```

## ORWA_TWL

### ORWA_TWL, CAAL, PacFIN and WCGOP combined

2017 file = 2001-2015
updated data = 2016-2024

```{r}
#check overlapping data
ss_data$agecomp %>% filter(fleet==4,year==2016)
raw_age_caal_comb %>% filter(fleet==4,year==2016) # new data in 2016 -> use them
```

doubling problem

```{r}
#check Nsamp -> ok
ss_data$agecomp %>% filter(fleet==4,year<2016) %>% pull(Nsamp) == rowSums(ss_data$agecomp %>% filter(fleet==4,year<2016) %>% select(a0:a65))

#check for which year /2 caal poses pb
ss_data$agecomp %>% filter(fleet==4,year<2016) %>% 
  pivot_longer(cols=-c(year,month,fleet,sex,part,
                                     ageerr,Lbin_lo,Lbin_hi,Nsamp),
                             names_prefix='a',names_to = 'age',
                             values_transform = as.numeric, values_to = "prev_value") %>% 
  mutate(bb=prev_value/2) %>% filter(!bb%in%c(0:100)) %>% View()
# pb year = 2004/2005/2006

# try to remove wcgop data which are 2004-2006
ss_data$agecomp %>% filter(fleet==4,year<2016) %>% 
  #pivot longer ssdata
  pivot_longer(cols=-c(year,month,fleet,sex,part,
                                     Nsamp,ageerr,Lbin_lo,Lbin_hi),
                             names_prefix='a',names_to = 'age',
                             values_transform = as.numeric, values_to = "prev_value") %>% 
  #merge with wcgop
  left_join(wcgop_caal %>% filter(fleet_nb==4,year<2016) %>% 
              dplyr::rename('fleet'=fleet_nb,'part'=partition,'Nsamp'=input_n) %>% 
              pivot_longer(cols=-c(year,month,fleet,sex,part,Nsamp,ageerr,Lbin_lo,Lbin_hi),
                            names_prefix='u',names_to = 'age',
                            values_transform = as.numeric,values_to = 'wcgop_value') %>% select(-Nsamp),
            by=c('year','month','fleet','sex','part','ageerr','Lbin_lo','Lbin_hi','age')) %>% 
  #substract wcgop from initial value
  mutate(value=ifelse(is.na(wcgop_value),prev_value,prev_value-wcgop_value)) %>% # filter(wcgopvalue!=0) %>% 
  #divide by 2 now
  mutate(value=(value/2)) %>% #pull(value) %>% unique()
  #check which year produce weird values -> STOP HERE
  filter(abs(value)==0.5) %>% select(-c(month, sex,part,ageerr))
  # idead was to use this new value to pivot wider and get a good table
    # pivot_wider(id_cols =c(year,month,fleet,sex,part,ageerr,Lbin_lo,Lbin_hi,Nsamp),
    #             values_from = 'value',#values_transform=as.integer,
    #             names_from = 'age',names_prefix = 'a' ) %>% 
  
```


data ready for SS = NO

```{r}
ORWA_TWL_PacFIN_WCGOP_caal <- ss_data$agecomp %>% filter(fleet==4,year<2016) %>% 
  bind_rows(raw_age_caal_comb %>% filter(fleet==4,year>=2016))
# mutate_at(vars(-c('year','month','fleet','sex','part','ageerr','Lbin_lo','Lbin_hi')), .funs=function(x){x/2}) %>% View()
```

### ORWA_TWL, ghost MAAL, PacFIN and WCGOP combined

2017 file = 2001-2016
updated data = 2016-2024

```{r}
#check overlapping data
ss_data$agecomp %>% filter(fleet==-4,year==2016)
raw_age_comps_comb %>% filter(fleet==-4,year==2016) # new data in 2016 -> use them
raw_age_comps_comb %>% filter(fleet==-4,year>2016)
```

data ready for SS = YES

```{r}
ORWA_TWL_PacFIN_WCGOP_maal <- ss_data$agecomp %>% filter(fleet==-4,year<2016) %>% 
  bind_rows(raw_age_comps_comb %>% filter(fleet==-4,year>=2016))
```

## ORWA_NONTWL

### ORWA_NONTWL, CAAL, PacFIN and WCGOP combined

2017 data = 2001-2015
updated data = 2016-2024

```{r}
#check overlapping data
ss_data$agecomp %>% filter(fleet==5,year==2015) == raw_age_caal_comb %>% filter(fleet==5,year==2015) 
# different data in 2015 -> use them ?

raw_age_caal_comb %>% filter(fleet==5,year>2015) 
```


doubling problem

```{r}
#check for which year /2 caal poses pb
ss_data$agecomp %>% filter(fleet==5,year<2016) %>% 
  pivot_longer(cols=-c(year,month,fleet,sex,part,
                                     Nsamp,ageerr,Lbin_lo,Lbin_hi),
                             names_prefix='a',names_to = 'age',
                             values_transform = as.numeric, values_to = "prev_value") %>% 
  mutate(bb=prev_value/2) %>% filter(!bb%in%c(0:10)) %>% select(-c(month,sex,part)) %>% View()

# check if removing wcgop will solve this /2 pb -> 2004/2006/2007 remain weird
ss_data$agecomp %>% filter(fleet==5,year<2016) %>% 
  pivot_longer(cols=-c(year,month,fleet,sex,part,
                                     Nsamp,ageerr,Lbin_lo,Lbin_hi),
                             names_prefix='a',names_to = 'age',
                             values_transform = as.numeric, values_to = "prev_value") %>% 
  left_join(wcgop_caal %>% filter(fleet_nb==5,year<2016) %>% 
              dplyr::rename('fleet'=fleet_nb,'part'=partition,'Nsamp'=input_n) %>% 
              pivot_longer(cols=-c(year,month,fleet,sex,part,Nsamp,ageerr,Lbin_lo,Lbin_hi),
                            names_prefix='u',names_to = 'age',
                            values_transform = as.numeric,values_to = 'wcgop_value') %>% select(-Nsamp),
            by=c('year','month','fleet','sex','part','ageerr','Lbin_lo','Lbin_hi','age')) %>% 
  mutate(value=ifelse(is.na(wcgop_value),prev_value,prev_value-wcgop_value)) %>% # filter(wcgopvalue!=0) %>% 
  mutate(value=(value/2)) %>% #pull(value) %>% unique()
  filter(abs(value)==0.5) %>% select(-c(month, sex,part,ageerr))
    pivot_wider(id_cols =c(year,month,fleet,sex,part,ageerr,Lbin_lo,Lbin_hi,Nsamp),
                values_from = 'value',#values_transform=as.integer,
                names_from = 'age',names_prefix = 'a' ) %>% 
  
```


data ready for SS = NO -> doubling pb not solve

```{r}
ORWA_NONTWL_PacFIN_WCGOP_caal <- ss_data$agecomp %>% filter(fleet==5,year<2016) %>% 
  bind_rows(raw_age_caal_comb %>% filter(fleet==5,year>=2016))
```

### ORWA_NONTWL, ghost MAAL, PacFIN and WCGOP combined

2017 file = 2001-2014 
updated data = 2015-2024

```{r}
#check overlapping data
ss_data$agecomp %>% filter(fleet==-5,year==2015) == raw_age_comps_comb %>% filter(fleet==-5,year==2015) 
# new data in 2015 -> use them
raw_age_comps_comb %>% filter(fleet==-5,year>=2016)
```

data ready for SS = YES

```{r}
ORWA_NONTWL_PacFIN_WCGOP_maal <- ss_data$agecomp %>% filter(fleet==-5,year<2015) %>% 
  bind_rows(raw_age_comps_comb %>% filter(fleet==-5,year>=2015))
```



## Combine everything

TBD when all previous issues are resolved

```{r}

```

